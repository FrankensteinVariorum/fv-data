---
title: "Hypothes.is Annotations Report"
author: "Matthew Lincoln"
date: "4/12/2019"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  dev = "svg")
library(tidyverse)
library(fs)
library(rvest)
```

```{r read_data}
his_csv <- "data/hypothesis.csv"
tag_match_pattern <- "([a-z]+)\\[([0-9]+)\\]"

his <- read_csv(his_csv) %>% 
  extract(html_start_node, c("start_tag", "start_tag_index"), regex = tag_match_pattern, remove = FALSE, convert = TRUE) %>% 
  extract(html_end_node, c("end_tag", "end_tag_index"), regex = tag_match_pattern, remove = FALSE, convert = TRUE) %>% 
  mutate(
    book = str_extract(source, "[0-9]{4}"),
    annotator = str_match(user, "acct:([a-z]+?)@")[,2],
    type = case_when(
      !is.na(reply_to) ~ "reply",
      TRUE ~ "annotation"
    ),
    n_tags = coalesce(str_count(tags, ";"), 0L))

# Get book data
book_length <- function(url) {
  read_html(url) %>% 
    html_nodes("p") %>% 
    length()
}

book_lengths <- his %>% 
  pull(source) %>% 
  unique() %>% 
  set_names() %>% 
  map_int(book_length) %>% 
  enframe(name = "source", value = "n_paragraphs")

his <- his %>% 
  left_join(book_lengths, by = "source")
```

This report is based on the status of Frankenstein hypothes.is annotations as of `r format(file_info(his_csv)$modification_time, "%F")`

## Timeline

`r scales::percent(mean(is.na(his$reply_to)))` of annotations are directly on the text, while another `r scales::percent(mean(!is.na(his$reply_to)))` are comments on other annotations.

```{r timeline}
ggplot(his, aes(x = updated, fill = book)) +
  geom_histogram()
```

## Tags

Of the `r scales::percent(mean(!is.na(his$tags)))` of annotations that have tags:

```{r tagged}
ggplot(his, aes(x = n_tags, fill = as.factor(n_tags))) +
  geom_histogram() +
  scale_fill_viridis_d(guide = FALSE) +
  labs(x = "Tags per annotation", y = NULL)
```

```{r extract_tags}
tags <- his %>% 
  select(id, book, tags) %>% 
  filter(!is.na(tags)) %>%
  separate(tags, into = paste0("tag", 1:14), fill = "right") %>% 
  gather(tagn, tag, contains("tag"), na.rm = TRUE) %>% 
  select(-tagn)
```

```{r tags}
tags %>% 
  mutate(tag_group = fct_rev(fct_infreq(fct_lump(tag, n = 20)))) %>% 
  ggplot(aes(x = tag_group, fill = book)) +
  geom_bar() +
  coord_flip()
```

## Book location

I've approximated the annotation locations based on the paragraph numbers they're anchored to.

```{r book_position}
his %>% 
  filter(!is.na(start_tag_index), !is.na(start_offset)) %>% 
  mutate(book_position = start_tag_index / n_paragraphs) %>% 
  ggplot(aes(x = book_position, fill = annotator)) +
  geom_histogram(binwidth = 0.03) +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) + 
  facet_wrap(~ book, ncol = 1)
```


